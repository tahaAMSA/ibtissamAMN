// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  ADMIN
  SOCIAL_WORKER
  MEDICAL
  EDUCATIONAL
  TECHNICAL
  FINANCIAL
}

enum DocumentType {
  IDENTITY_CARD
  BIRTH_CERTIFICATE
  RESIDENCE_CERTIFICATE
  MEDICAL_CERTIFICATE
  SCHOOL_CERTIFICATE
  INCOME_CERTIFICATE
  FAMILY_COMPOSITION
  PHOTO
  OTHER
}

enum DocumentStatus {
  ACTIVE
  ARCHIVED
  EXPIRED
}

enum InterventionStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum StayStatus {
  ACTIVE
  ENDED
  SUSPENDED
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}

enum ResourceType {
  FOOD
  CLOTHING
  HYGIENE
  SCHOOL_SUPPLIES
  MEDICAL
  OTHER
}

enum EducationStatus {
  ACTIVE
  COMPLETED
  ABANDONED
  SUSPENDED
}

enum ProgramStatus {
  ACTIVE
  COMPLETED
  ABANDONED
  SUSPENDED
}

enum ActivityCategory {
  SPORTS
  CULTURAL
  EDUCATIONAL
  SOCIAL
  RECREATIONAL
  THERAPEUTIC
  OTHER
}

enum ActivityStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ProjectProgress {
  IDEA
  DEVELOPMENT
  IMPLEMENTATION
  FINALIZATION
  COMPLETED
}

enum ProjectStatus {
  ACTIVE
  SUSPENDED
  COMPLETED
  ABANDONED
}

// Models
model User {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  email                     String?         @unique
  username                  String?         @unique
  isAdmin                   Boolean         @default(false)
  files                     File[]
  role                      UserRole        @default(SOCIAL_WORKER)
  firstName                 String?
  lastName                  String?
  phone                     String?
  isActive                  Boolean         @default(true)
  updatedAt                 DateTime        @updatedAt

  // GEPS relations
  socialInterventions       SocialIntervention[]
  stays                     Stay[]
  meals                     Meal[]
  activities                Activity[]
  activityParticipations    ActivityParticipation[]
  trainings                 Training[]
  entrepreneurialProjects   EntrepreneurialProject[]
  budgets                   Budget[]
  expenses                  Expense[]
  revenues                  Revenue[]
  documents                 Document[]
  enrollments               Enrollment[]
  educations                Education[]
}

model File {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  user                      User            @relation(fields: [userId], references: [id])
  userId                    String
  name                      String
  type                      String
  key                       String
  uploadUrl                 String
}

// Enums for Beneficiary Form
enum StatutBeneficiaire {
  RESIDENTE
  MIGRANTE
  TOURISTE
  REFUGIEE
  EN_TRANSIT
  AUTRE
}

enum StatutMatrimonial {
  CELIBATAIRE
  MARIEE_AVEC_CONTRAT
  MARIEE_SANS_CONTRAT
  DIVORCEE
  VEUVE
  FIANCEE
  MERE_CELIBATAIRE
  AUTRE
}

enum TypeLogement {
  MAISON_FAMILIALE
  AVEC_FAMILLE_EPOUSE
  AVEC_FAMILLE_EPOUX
  INDEPENDANT
}

enum SituationSante {
  MALADIE_CHRONIQUE
  MALADIE_MENTALE
  HANDICAP_SENSORIEL
  HANDICAP_MOTEUR
  HANDICAP_INTELLECTUEL
  ENCEINTE
  NORMALE
}

enum NiveauEducation {
  ANALPHABETE
  PRIMAIRE
  COLLEGE
  LYCEE
  UNIVERSITAIRE
  AUTRE
}

enum ActiviteProfessionnelle {
  FEMME_MENAGE
  EMPLOYEE
  FONCTIONNAIRE
  PROFESSION_LIBERALE
  ETUDIANTE
  AU_FOYER
  SANS_EMPLOI
  RETRAITEE
  AUTRE
}

enum StatutDossier {
  PREMIERES_ETAPES
  MI_PARCOURS
  AVANCEE
  TRES_AVANCEE
  TERMINEE
}

enum TrancheAge {
  MOINS_18
  AGE_18_25
  AGE_26_30
  AGE_31_35
  AGE_36_40
  AGE_41_45
  AGE_46_50
  PLUS_50
}

model Beneficiary {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  
  // Informations basiques
  firstName                 String
  lastName                  String
  gender                    String
  dateOfBirth               DateTime
  phone                     String?
  address                   String?
  familySituation           String?
  professionalSituation     String?
  isActive                  Boolean         @default(true)
  
  // Informations supplémentaires
  emergencyContact          String?
  emergencyPhone            String?
  nationalId                String?
  birthPlace                String?
  maritalStatus             String?
  numberOfChildren          Int?            @default(0)
  monthlyIncome             Int?            @default(0)
  educationLevel            String?
  healthConditions          String?
  notes                     String?
  
  // Informations entretien
  intervenanteName          String?
  interviewDuration         String?
  
  // Historique avec le centre
  dejabeneficie             Boolean?        @default(false)
  dateBeneficePrecedent     DateTime?
  numDossierPrecedent       String?
  declarationViolenceCellule String[]
  
  // Identité détaillée
  nomComplet                String?
  age                       Int?
  nationalite               String?
  cni                       String?
  statut                    StatutBeneficiaire?
  
  // Dossier
  numDossier                String?
  annee                     Int?
  dateOuverture             DateTime?
  statutDossier             StatutDossier?
  
  // Motifs de la visite
  motifs                    String[]
  
  // Canal de connaissance
  canaux                    String[]
  
  // Origine de l'orientation
  sourcesOrientation        String[]
  
  // Profil personnel détaillé
  trancheAge                TrancheAge?
  ageMariage                Int?
  nbEnfants                 Int?
  dureeMariageCourant       String?
  mariagePrecedent          Boolean?
  statutMatrimonial         StatutMatrimonial?
  logement                  TypeLogement?
  sante                     SituationSante[]
  education                 NiveauEducation?
  profession                ActiviteProfessionnelle?
  
  // Violences (JSON pour stocker la structure complexe)
  violencePhysique          Json?
  violencePsychologique     Json?
  violenceSexuelle          Json?
  violenceEconomique        Json?
  violenceElectronique      Json?
  
  // Informations sur l'agresseur
  agresseurInfo             Json?
  
  // Description et documents
  description               String?
  rapport                   String?
  piecesJointes             String[]
  
  // Services et suivi
  proceduresJuridiques      Json?
  proceduresAdministratives Json?
  hebergement               Boolean?        @default(false)
  priseEnChargeDistance     Boolean?        @default(false)
  orientationInterne        String[]
  orientationExterne        String[]
  satisfaction              String?
  resultatFinal             String?

  // Relations
  documents                 Document[]
  stays                     Stay[]
  meals                     Meal[]
  activityParticipations    ActivityParticipation[]
  trainings                 Training[]
  entrepreneurialProjects   EntrepreneurialProject[]
  enrollments               Enrollment[]
  educations                Education[]
}

model Document {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  type                      DocumentType
  content                   String
  date                      DateTime
  status                    DocumentStatus  @default(ACTIVE)

  // Relations
  beneficiary               Beneficiary     @relation(fields: [beneficiaryId], references: [id], onDelete: Cascade)
  beneficiaryId             String
  user                      User            @relation(fields: [userId], references: [id])
  userId                    String
}

model SocialIntervention {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  title                     String
  description               String
  interventionDate          DateTime
  duration                  Int?            // in minutes
  location                  String?
  status                    InterventionStatus @default(PLANNED)

  // Relations
  user                      User            @relation(fields: [userId], references: [id])
  userId                    String
}

model Stay {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  dormitory                 String
  bed                       String
  checkInDate               DateTime
  checkOutDate              DateTime?
  status                    StayStatus      @default(ACTIVE)

  // Relations
  beneficiary               Beneficiary     @relation(fields: [beneficiaryId], references: [id], onDelete: Cascade)
  beneficiaryId             String
  user                      User            @relation(fields: [userId], references: [id])
  userId                    String
}

model Meal {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  type                      MealType
  menu                      String
  preferences               String?         // allergies, special diets
  date                      DateTime
  quantity                  Int             @default(1)

  // Relations
  beneficiary               Beneficiary     @relation(fields: [beneficiaryId], references: [id], onDelete: Cascade)
  beneficiaryId             String
  user                      User            @relation(fields: [userId], references: [id])
  userId                    String
}

model Resource {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  name                      String
  type                      ResourceType
  quantity                  Int
  unit                      String          // kg, units, liters, etc.
  module                    String?         // concerned module
  alertThreshold            Int?            // threshold to trigger restock alert
  isActive                  Boolean         @default(true)
}

model Education {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  institution               String
  level                     String
  academicYear              String
  results                   String?
  activeSupport             Boolean         @default(false)
  startDate                 DateTime
  endDate                   DateTime?
  status                    EducationStatus @default(ACTIVE)

  // Relations
  beneficiary               Beneficiary     @relation(fields: [beneficiaryId], references: [id], onDelete: Cascade)
  beneficiaryId             String
  user                      User            @relation(fields: [userId], references: [id])
  userId                    String
}

model Enrollment {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  program                   String
  module                    String?
  enrollmentDate            DateTime
  endDate                   DateTime?
  status                    ProgramStatus   @default(ACTIVE)

  // Relations
  beneficiary               Beneficiary     @relation(fields: [beneficiaryId], references: [id], onDelete: Cascade)
  beneficiaryId             String
  user                      User            @relation(fields: [userId], references: [id])
  userId                    String
}

model Activity {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  title                     String
  category                  ActivityCategory
  description               String?
  location                  String
  startDate                 DateTime
  endDate                   DateTime?
  capacity                  Int?
  status                    ActivityStatus  @default(PLANNED)

  // Relations
  user                      User            @relation(fields: [userId], references: [id])
  userId                    String
  participations            ActivityParticipation[]
}

model ActivityParticipation {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  isPresent                 Boolean         @default(false)
  comment                   String?

  // Relations
  beneficiary               Beneficiary     @relation(fields: [beneficiaryId], references: [id], onDelete: Cascade)
  beneficiaryId             String
  activity                  Activity        @relation(fields: [activityId], references: [id], onDelete: Cascade)
  activityId                String
  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  @@unique([beneficiaryId, activityId])
}

model Training {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  title                     String
  description               String?
  startDate                 DateTime
  endDate                   DateTime?
  location                  String?
  capacity                  Int?
  status                    ActivityStatus  @default(PLANNED)

  // Relations
  user                      User            @relation(fields: [userId], references: [id])
  userId                    String
  beneficiaries             Beneficiary[]
}

model EntrepreneurialProject {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  title                     String
  description               String
  idea                      String
  mentoring                 String?
  progress                  ProjectProgress @default(IDEA)
  estimatedBudget           Float?
  status                    ProjectStatus   @default(ACTIVE)

  // Relations
  beneficiary               Beneficiary     @relation(fields: [beneficiaryId], references: [id], onDelete: Cascade)
  beneficiaryId             String
  user                      User            @relation(fields: [userId], references: [id])
  userId                    String
}

model Budget {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  module                    String
  year                      Int
  initialAmount             Float
  usedAmount                Float           @default(0)
  description               String?

  // Relations
  user                      User            @relation(fields: [userId], references: [id])
  userId                    String
  expenses                  Expense[]
  revenues                  Revenue[]
}

model Expense {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  label                     String
  amount                    Float
  date                      DateTime
  category                  String?
  justification             String?

  // Relations
  budget                    Budget          @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  budgetId                  String
  user                      User            @relation(fields: [userId], references: [id])
  userId                    String
}

model Revenue {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  source                    String
  amount                    Float
  date                      DateTime
  description               String?

  // Relations
  budget                    Budget          @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  budgetId                  String
  user                      User            @relation(fields: [userId], references: [id])
  userId                    String
}
